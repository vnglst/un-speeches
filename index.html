<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive 3D Globe</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
      }

      #globe {
        width: 100%;
        height: 100vh;
        position: relative;
      }

      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
      }
    </style>
  </head>
  <body>
    <div id="globe"></div>
    <div id="info">Drag to rotate the globe. Click on a country for more information.</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script>
      console.log("Script started");

      const width = window.innerWidth;
      const height = window.innerHeight;
      const sensitivity = 75;

      const svg = d3.select("#globe").append("svg").attr("width", width).attr("height", height);

      const globe = svg.append("g");

      // Set up initial rotation
      let rotation = [0, 0, 0];
      let lastMousePosition = [0, 0];

      // Set up projection
      const projection = d3
        .geoOrthographic()
        .scale(Math.min(width, height) / 2.5)
        .translate([width / 2, height / 2]);

      const path = d3.geoPath().projection(projection);

      // Add water
      globe
        .append("circle")
        .attr("fill", "#a4d3ee")
        .attr("stroke", "#000")
        .attr("stroke-width", "0.2")
        .attr("cx", width / 2)
        .attr("cy", height / 2)
        .attr("r", projection.scale());

      // Enable rotation
      svg.call(
        d3.drag().on("drag", (event) => {
          const rotate = projection.rotate();
          const k = sensitivity / projection.scale();
          projection.rotate([rotate[0] + event.dx * k, rotate[1] - event.dy * k]);
          path.projection(projection);
          globe.selectAll("path").attr("d", path);
        })
      );

      console.log("Fetching map data...");
      d3.json("./topology.json")
        .then(function (data) {
          console.log("Map data received:", data);
          const countries = topojson.feature(data, data.objects.countries);

          globe
            .selectAll("path")
            .data(countries.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("fill", "#3cb371")
            .attr("stroke", "#fff")
            .on("click", function (event, d) {
              console.log("Country clicked:", d.properties.name);
              d3.select("#info").text(`Country: ${d.properties.name}`);
              event.stopPropagation();
            })
            .append("title")
            .text((d) => d.properties.name);

          console.log("Globe rendering complete");
        })
        .catch(function (error) {
          console.error("Error loading or parsing map data:", error);
          document.body.innerHTML = "<h1>Error: Failed to load or parse map data</h1>";
        });

      // Handle window resize
      window.addEventListener("resize", () => {
        const width = window.innerWidth;
        const height = window.innerHeight;
        svg.attr("width", width).attr("height", height);
        projection.translate([width / 2, height / 2]);
        globe.selectAll("path").attr("d", path);
      });

      // Add stars
      const numStars = 100;
      const globeEl = document.querySelector("#globe");
      for (let i = 0; i < numStars; i++) {
        const star = document.createElement("div");
        star.className = "star";
        star.style.width = `${Math.random() * 2 + 1}px`;
        star.style.height = star.style.width;
        star.style.top = `${Math.random() * height}px`;
        star.style.left = `${Math.random() * width}px`;
        document.body.insertBefore(star, globeEl);
      }

      // Rotate the globe slowly
      d3.timer(function (elapsed) {
        const rotate = projection.rotate();
        projection.rotate([rotate[0] + 0.2, rotate[1]]);
        path.projection(projection);
        globe.selectAll("path").attr("d", path);
      });
    </script>
  </body>
</html>
