<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive 3D Globe</title>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #000;
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
      }

      #title {
        text-align: center;
        color: white;
        margin: 20px;
      }

      #container {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      #sdg-container {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
        background: #111;
        z-index: 10;
      }

      #globe-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }

      #globe {
        width: 100%;
        height: 100%;
      }

      #info {
        background: white;
        padding: 10px;
        border-radius: 5px;
        position: absolute;
        bottom: 10px;
        right: 10px;
        display: flex;
        flex-wrap: wrap;
        flex-direction: row;
        gap: 10px;
        z-index: 10;
        max-width: 130px;
      }

      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
      }

      .active-country {
        fill: rgb(60, 179, 113);
      }

      .sdg-button {
        transition: filter 0.3s;
      }

      .sdg-button:hover {
        filter: none !important;
      }
    </style>
  </head>
  <body>
    <h1 id="title">Interactive 3D Globe</h1>
    <div id="container">
      <div id="sdg-container"></div>
      <div id="globe-container">
        <div id="globe"></div>
      </div>
      <div id="info"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script>
      let sdgData = {};

      const sdgDefinitions = {
        1: {
          title: "No Poverty",
          description: "End poverty in all its forms everywhere.",
        },
        2: {
          title: "Zero Hunger",
          description: "End hunger, achieve food security, and promote sustainable agriculture.",
        },
        3: {
          title: "Good Health and Well-being",
          description: "Ensure healthy lives and promote well-being for all.",
        },
        4: {
          title: "Quality Education",
          description: "Ensure inclusive and equitable education and lifelong learning opportunities.",
        },
        5: {
          title: "Gender Equality",
          description: "Achieve gender equality and empower all women and girls.",
        },
        6: {
          title: "Clean Water and Sanitation",
          description: "Ensure availability and sustainable management of water and sanitation.",
        },
        7: {
          title: "Affordable and Clean Energy",
          description: "Ensure access to affordable, reliable, and sustainable energy.",
        },
        8: {
          title: "Decent Work and Economic Growth",
          description: "Promote sustained, inclusive economic growth, full and productive employment.",
        },
        9: {
          title: "Industry, Innovation, and Infrastructure",
          description: "Build resilient infrastructure, promote inclusive industrialization, and foster innovation.",
        },
        10: {
          title: "Reduced Inequality",
          description: "Reduce inequality within and among countries.",
        },
        11: {
          title: "Sustainable Cities and Communities",
          description: "Make cities inclusive, safe, resilient, and sustainable.",
        },
        12: {
          title: "Responsible Consumption and Production",
          description: "Ensure sustainable consumption and production patterns.",
        },
        13: {
          title: "Climate Action",
          description: "Take urgent action to combat climate change and its impacts.",
        },
        14: {
          title: "Life Below Water",
          description: "Conserve and sustainably use oceans, seas, and marine resources.",
        },
        15: {
          title: "Life on Land",
          description:
            "Protect, restore, and promote sustainable use of terrestrial ecosystems and halt biodiversity loss.",
        },
        16: {
          title: "Peace, Justice, and Strong Institutions",
          description:
            "Promote peaceful, inclusive societies, ensure justice for all, and build accountable institutions.",
        },
        17: {
          title: "Partnerships for the Goals",
          description: "Strengthen global partnerships to support sustainable development.",
        },
      };

      const width = window.innerWidth;
      const height = window.innerHeight;
      const sensitivity = 75;
      let rotationStopped = false; // Flag to control rotation
      let selectedCountry = null; // Track the selected country

      const svg = d3.select("#globe").append("svg").attr("width", width).attr("height", height);

      const globe = svg.append("g");

      // Set up initial rotation
      let rotation = [0, 0, 0];
      let lastMousePosition = [0, 0];
      let isDragging = false;

      // Set up projection
      const projection = d3
        .geoOrthographic()
        .scale(Math.min(width, height) / 2.5)
        .translate([width / 2, height / 2]);

      const path = d3.geoPath().projection(projection);

      // Add water
      globe
        .append("circle")
        .attr("fill", "#fff")
        .attr("stroke", "#000")
        .attr("stroke-width", "0.2")
        .attr("cx", width / 2)
        .attr("cy", height / 2)
        .attr("r", projection.scale());

      // Enable rotation
      svg.call(
        d3
          .drag()
          .on("start", () => {
            isDragging = true;
          })
          .on("drag", (event) => {
            const rotate = projection.rotate();
            const k = sensitivity / projection.scale();
            projection.rotate([rotate[0] + event.dx * k, rotate[1] - event.dy * k]);
            path.projection(projection);
            requestAnimationFrame(() => {
              globe.selectAll("path").attr("d", path);
            });
          })
          .on("end", () => {
            rotationStopped = true;
            isDragging = false;
          })
      );

      d3.json("./topology_with_iso_code.json")
        .then(function (data) {
          console.log("Map data received:", data);
          const countries = topojson.feature(data, data.objects.countries);

          globe
            .selectAll("path")
            .data(countries.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("fill", "#009edb")
            .attr("stroke", "#fff")
            .on("click", function (event, d) {
              event.stopPropagation();
              if (selectedCountry === d) {
                // Deselect the country
                d3.select("#info").text("");
                d3.selectAll("path").attr("stroke", "#fff").attr("stroke-width", "1px");
                selectedCountry = null;
              } else {
                // Select the country
                const countryCode = d.properties.code;
                const countrySDGs = Object.keys(sdgData).filter((sdg) =>
                  sdgData[sdg].some((entry) => entry.country_code.toUpperCase() === countryCode)
                );

                // Clear previous info and add new info
                const infoDiv = d3.select("#info").html(d.properties.name);
                // make sure label uses full width
                infoDiv.style("width", "100%");

                countrySDGs.forEach((sdg) => {
                  infoDiv
                    .append("img")
                    .attr("src", `./images/SDG-${sdg.padStart(2, "0")}.png`)
                    .attr("width", 50)
                    .attr("height", 50)
                    .attr("alt", `SDG ${sdg}`)
                    .attr("style", "border-radius: 5px;");
                });

                d3.selectAll("path").attr("stroke", "#fff").attr("stroke-width", "1px");
                d3.select(this).attr("stroke", "#000").attr("stroke-width", "2px");
                d3.select(this).raise();
                selectedCountry = d;
                rotationStopped = true; // Stop rotation when a country is selected
              }
            })
            .append("title")
            .text((d) => d.properties.name);

          console.log("Globe rendering complete");
        })
        .catch(function (error) {
          console.error("Error loading or parsing map data:", error);
          document.body.innerHTML = "<h1>Error: Failed to load or parse map data</h1>";
        });

      // Load the list of SDGs from the JSON file
      d3.json("./sgds.json")
        .then(function (data) {
          sdgData = data;

          // Create SDG buttons with images
          const sdgContainer = d3.select("#sdg-container");

          Object.keys(sdgData).forEach((sdg) => {
            const img = sdgContainer
              .append("img")
              .attr("src", `./images/SDG-${sdg.padStart(2, "0")}.png`)
              .attr("width", 75)
              .attr("height", 75)
              .attr("alt", `SDG ${sdg}`)
              .attr("class", "sdg-button")
              .style("cursor", "pointer")
              .style("border-radius", "10px")
              .style("filter", "grayscale(100%)")
              .on("click", function () {
                d3.select("#title").text(sdgDefinitions[sdg].title);
                d3.selectAll("#sdg-container img").style("filter", "grayscale(100%)");
                d3.select(this).style("filter", "none");
                const activeCountries = sdgData[sdg].map((entry) => entry.country_code.toUpperCase());
                globe.selectAll("path").attr("class", (d) => {
                  return activeCountries.includes(d.properties.code) ? "active-country" : "inactive-country";
                });
              });
            // Preselect the first SDG
            if (sdg === "1") {
              img.dispatch("click");
            }
          });
        })
        .catch(function (error) {
          console.error("Error loading or parsing SDG data:", error);
          document.body.innerHTML = "<h1>Error: Failed to load or parse SDG data</h1>";
        });

      // Handle window resize
      window.addEventListener("resize", () => {
        const width = window.innerWidth;
        const height = window.innerHeight;
        svg.attr("width", width).attr("height", height);
        projection.translate([width / 2, height / 2]);
        globe.selectAll("path").attr("d", path);
      });

      // Add stars
      const numStars = 100;
      const globeEl = document.querySelector("#title");
      for (let i = 0; i < numStars; i++) {
        const star = document.createElement("div");
        star.className = "star";
        star.style.width = `${Math.random() * 2 + 1}px`;
        star.style.height = star.style.width;
        star.style.top = `${Math.random() * height}px`;
        star.style.left = `${Math.random() * width}px`;
        document.body.insertBefore(star, globeEl);
      }

      // Rotate the globe slowly
      d3.timer(function (elapsed) {
        if (!rotationStopped) {
          // Check if rotation is stopped
          const rotate = projection.rotate();
          projection.rotate([rotate[0] + 0.05, rotate[1]]);
          path.projection(projection);
          globe.selectAll("path").attr("d", path);
        }
      });

      // Deselect country and resume rotation when clicking outside the globe
      document.body.addEventListener("click", (event) => {
        if (!event.target.closest("#globe")) {
          d3.select("#info").text("");
          d3.selectAll("path").attr("stroke", "#fff").attr("stroke-width", "1px");
          selectedCountry = null;
        }
      });
    </script>
  </body>
</html>
